---
title: "Effect of onboarding on motivation types"
date: "`r Sys.Date()`"
format: 
  html:
    code-fold: true
    code-summary: "Show code"
    code-tools: true
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r libraries}
library(data.table)
library(dplyr)
library(gtsummary)
library(ggplot2)
library(tidyr)
library(tibble)
library(psych)
library(careless)
library(kableExtra)
library(broom)
library(purrr)
```

```{r paths}
wd <- list()
wd$data   <- "C:/Users/huism080/OneDrive - Wageningen University & Research/Research/Study-3/analysis/data/"
wd$output <- "C:/Users/huism080/OneDrive - Wageningen University & Research/Research/Study-3/analysis/output/"
```

## Data Loading and Preparation

```{r data-loading}
raw <- fread(paste0(wd$data, "pilot_onboarding_complete_20250923.csv"))

# Check attention check (3 people failed but responses seem genuine)
failed_att <- raw %>% 
  filter(Status == 0 & Finished == 1 & consent == 1) %>% 
  filter(motivation_10 != 3)
```

```{r data-processing}
df <- raw %>% 
  filter(Status == 0 & Finished == 1 & consent == 1) %>% 
  select(36,37,45:55,57:61) %>% 
  mutate(across(c(3, 5:15,17), as.numeric)) %>%  # Convert to numeric first
  mutate(
    # Create motivation composites - now variables are numeric
    mot_ex = (motivation_1 + motivation_2 + motivation_3) / 3,
    mot_id = (motivation_4 + motivation_5 + motivation_6) / 3,
    mot_in = (motivation_7 + motivation_8 + motivation_9) / 3,
    # Factor variables
    condition = factor(ifelse(is.na(`Q32_Click Count`), 0, 1), 
                      labels = c("Intrinsic", "Identified")),
    gender = factor(gender, levels = 4:7, 
                   labels = c("Male", "Female", "Non-binary", "Other")),
    employ = factor(employ)
  ) %>% 
  rownames_to_column(var = "id")
```

## Sample Characteristics

```{r sample-table}
df %>% 
  select(condition, gender, age, employ) %>% 
  tbl_summary(by = condition) %>% 
  add_overall() %>% 
  modify_header(label ~ "**Variable**") %>% 
  as_kable_extra() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Psychometric Analysis

### Factor Structure

```{r factor-analysis}
fa_results <- df %>% 
  select(motivation_1:motivation_9) %>% 
  fa(nfactors = 3, rotate = "varimax")

fa_results$loadings %>% 
  unclass() %>% 
  as.data.frame() %>% 
  rownames_to_column("Item") %>% 
  kable(digits = 3, caption = "Factor Loadings for Motivation Items") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Internal Consistency

```{r reliability-table}
reliability_data <- data.frame(
  Scale = c("Extrinsic", "Identified", "Intrinsic"),
  Alpha = c(
    alpha(df %>% select(motivation_1:motivation_3))$total$raw_alpha,
    alpha(df %>% select(motivation_4:motivation_6))$total$raw_alpha,
    alpha(df %>% select(motivation_7:motivation_9))$total$raw_alpha
  ),
  Items = c("1-3", "4-6", "7-9")
)

reliability_data %>%
  kable(digits = 3, caption = "Internal Consistency (Cronbach's Alpha)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Descriptive Statistics

### Motivation Scores by Condition

```{r descriptives-table}
df %>%
  select(condition, mot_ex, mot_id, mot_in) %>%
  group_by(condition) %>%
  summarise(
    across(starts_with("mot"), 
           list(Mean = ~ mean(.x, na.rm = TRUE), 
                SD = ~ sd(.x, na.rm = TRUE)), 
           .names = "{.fn}_{.col}"),
    .groups = "drop"
  ) %>%
  kable(digits = 2, caption = "Descriptive Statistics by Condition") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Motivation Scores Visualization

```{r motivation-plot, fig.cap="Mean motivation scores by experimental condition"}
df %>%
  pivot_longer(cols = c(mot_ex, mot_id, mot_in),
               names_to = "motivation_type",
               names_prefix = "mot_",
               values_to = "score") %>%
  mutate(motivation_type = case_when(
    motivation_type == "ex" ~ "Extrinsic",
    motivation_type == "id" ~ "Identified", 
    motivation_type == "in" ~ "Intrinsic"
  )) %>%
  ggplot(aes(x = motivation_type, y = score, fill = condition)) +
  stat_summary(geom = "col", fun = mean, position = "dodge", alpha = 0.8) +
  stat_summary(geom = "errorbar", fun.data = mean_se, 
               position = position_dodge(0.9), width = 0.2) +
  labs(title = "Mean Motivation Scores by Condition",
       x = "Motivation Type", y = "Mean Score", fill = "Condition") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Inferential Statistics

### Main Effects: Condition on Motivation

```{r extrinsic-anova}
aov_ex <- aov(mot_ex ~ condition, data = df)
tidy(aov_ex) %>%
  kable(digits = 3, caption = "ANOVA: Condition → Extrinsic Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r identified-anova}
aov_id <- aov(mot_id ~ condition, data = df)
tidy(aov_id) %>%
  kable(digits = 3, caption = "ANOVA: Condition → Identified Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r intrinsic-anova}
aov_in <- aov(mot_in ~ condition, data = df)
tidy(aov_in) %>%
  kable(digits = 3, caption = "ANOVA: Condition → Intrinsic Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

**Finding:** No significant differences in motivation between conditions (all p \> .05).

### Demographic Predictors of Motivation

#### Extrinsic Motivation

```{r extrinsic-demo-anova}
aov_ex_demo <- aov(mot_ex ~ gender + age + employ, data = df)
tidy(aov_ex_demo) %>%
  filter(term != "Residuals") %>%
  kable(digits = 3, caption = "ANOVA: Demographics → Extrinsic Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

#### Identified Motivation

```{r identified-demo-anova}
aov_id_demo <- aov(mot_id ~ gender + age + employ, data = df)
tidy(aov_id_demo) %>%
  filter(term != "Residuals") %>%
  kable(digits = 3, caption = "ANOVA: Demographics → Identified Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

#### Intrinsic Motivation

```{r intrinsic-demo-anova}
aov_in_demo <- aov(mot_in ~ gender + age + employ, data = df)
tidy(aov_in_demo) %>%
  filter(term != "Residuals") %>%
  kable(digits = 3, caption = "ANOVA: Demographics → Intrinsic Motivation") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Visualization of Significant Effects

```{r demographic-plots, fig.cap="Demographic effects on motivation", fig.height=4}
#| layout-ncol: 2

# Age effect on extrinsic motivation
p1 <- ggplot(df, aes(x = age, y = mot_ex)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Age × Extrinsic Motivation", x = "Age", y = "Score") +
  theme_minimal()

# Gender effect on identified motivation  
p2 <- ggplot(df, aes(x = gender, y = mot_id)) +
  geom_boxplot(alpha = 0.7, fill = "lightblue") +
  labs(title = "Gender × Identified Motivation", x = "Gender", y = "Score") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p1)
print(p2)
```